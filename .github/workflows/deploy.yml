name: Deploy to Local Runner

on:
  push:
    branches: [ main, master, develop ]
  workflow_dispatch:  # ĞŸĞ¾Ğ·Ğ²Ğ¾Ğ»ÑĞµÑ‚ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°Ñ‚ÑŒ Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ

jobs:
  # Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° Ğ¸ Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install backend dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run backend tests
        env:
          DATABASE_URL_ASYNC: postgresql+asyncpg://postgres:postgres@localhost:5432/test_db
          DATABASE_URL_SYNC: postgresql://postgres:postgres@localhost:5432/test_db
          JWT_SECRET_KEY: test-secret-key
        run: |
          pytest app/tests/ -v || echo "Tests failed but continuing..."
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm install
      
      - name: Build frontend
        working-directory: ./frontend
        env:
          VITE_API_BASE_URL: http://localhost:8001
        run: npm run build
      
      - name: Build Docker image
        run: |
          docker build -t ai-presentation:latest .

  # Ğ Ğ°Ğ·Ğ²ĞµÑ€Ñ‚Ñ‹Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ½Ğ° self-hosted runner
  deploy:
    name: Deploy to Local Runner
    runs-on: self-hosted  # Linux self-hosted runner
    needs: build-and-test
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || github.event_name == 'workflow_dispatch'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Load Docker image (if built in previous job)
        run: |
          echo "â„¹ï¸  If using self-hosted runner, build image locally or load from registry"
      
      - name: Stop existing containers
        shell: bash
        run: |
          docker compose down || true
      
      - name: Create .env file
        shell: bash
        run: |
          if [ ! -f .env ]; then
            cp env.example .env
            echo "âš ï¸  Please update .env file with your configuration"
          fi
      
      - name: Start services
        shell: bash
        run: |
          docker compose up -d --build
      
      - name: Check containers status
        shell: bash
        run: |
          echo "ğŸ“Š Checking containers status..."
          docker compose ps
          sleep 5
      
      - name: Wait for services
        shell: bash
        run: |
          echo "â³ Waiting for services to be ready..."
          sleep 15
          for i in {1..60}; do
            if docker compose ps | grep -q "Up" && curl -f http://localhost:8001/health > /dev/null 2>&1; then
              echo "âœ… Backend is ready"
              break
            fi
            echo "Waiting... ($i/60)"
            docker compose ps
            sleep 3
          done
      
      - name: Run migrations
        shell: bash
        run: |
          echo "ğŸ“¦ Running database migrations..."
          docker compose exec -T app python -m alembic upgrade head || echo "âš ï¸  Migrations failed, continuing..."
      
      - name: Health check
        shell: bash
        run: |
          echo "ğŸ¥ Checking service health..."
          echo "Checking backend..."
          curl -f http://localhost:8001/health || (echo "âŒ Backend health check failed" && docker compose logs app --tail=50 && exit 1)
          echo "âœ… Backend is healthy"
          echo "Checking frontend..."
          curl -f http://localhost:80/ || (echo "âŒ Frontend health check failed" && docker compose logs app --tail=50 && exit 1)
          echo "âœ… Frontend is healthy"
          echo "âœ… All services are healthy"
      
      - name: Show service status
        shell: bash
        run: |
          docker compose ps
          echo ""
          echo "ğŸŒ Frontend: http://localhost:80"
          echo "ğŸ”§ Backend API: http://localhost:8001"
          echo "ğŸ“Š API Docs: http://localhost:8001/docs"
